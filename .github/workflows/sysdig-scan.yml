name: Sysdig Container Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  scan-vote:
    name: Scan Vote Container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build vote image
        run: |
          cd voting-app/vote
          docker build -t vote:latest .

      - name: Scan vote image with Sysdig
        uses: sysdiglabs/scan-action@v5
        continue-on-error: true
        with:
          image-tag: vote:latest
          sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}
          sysdig-secure-url: https://app.us4.sysdig.com

  scan-result:
    name: Scan Result Container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build result image
        run: |
          cd voting-app/result
          docker build -t result:latest .

      - name: Scan result image with Sysdig
        uses: sysdiglabs/scan-action@v5
        continue-on-error: true
        with:
          image-tag: result:latest
          sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}
          sysdig-secure-url: https://app.us4.sysdig.com

  scan-worker:
    name: Scan Worker Container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build worker image
        run: |
          cd voting-app/worker
          docker build -t worker:latest .

      - name: Scan worker image with Sysdig
        uses: sysdiglabs/scan-action@v5
        continue-on-error: true
        with:
          image-tag: worker:latest
          sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}
          sysdig-secure-url: https://app.us4.sysdig.com
