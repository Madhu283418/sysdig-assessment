name: Sysdig Container Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  SYSDIG_SECURE_ENDPOINT: https://app.us4.sysdig.com

jobs:
  scan-vote:
    name: Scan Vote Container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build vote image
        run: |
          cd voting-app/vote
          docker build -t vote:${{ github.sha }} .

      - name: Scan vote image with Sysdig
        uses: sysdiglabs/scan-action@v5
        continue-on-error: true
        with:
          image-tag: vote:${{ github.sha }}
          sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}
          sysdig-secure-url: ${{ env.SYSDIG_SECURE_ENDPOINT }}
          input-type: docker-daemon
          ignore-failed-scan: true

  scan-result:
    name: Scan Result Container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build result image
        run: |
          cd voting-app/result
          docker build -t result:${{ github.sha }} .

      - name: Scan result image with Sysdig
        uses: sysdiglabs/scan-action@v5
        continue-on-error: true
        with:
          image-tag: result:${{ github.sha }}
          sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}
          sysdig-secure-url: ${{ env.SYSDIG_SECURE_ENDPOINT }}
          input-type: docker-daemon
          ignore-failed-scan: true

  scan-worker:
    name: Scan Worker Container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build worker image
        run: |
          cd voting-app/worker
          docker build -t worker:${{ github.sha }} .

      - name: Scan worker image with Sysdig
        uses: sysdiglabs/scan-action@v5
        continue-on-error: true
        with:
          image-tag: worker:${{ github.sha }}
          sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}
          sysdig-secure-url: ${{ env.SYSDIG_SECURE_ENDPOINT }}
          input-type: docker-daemon
          ignore-failed-scan: true
